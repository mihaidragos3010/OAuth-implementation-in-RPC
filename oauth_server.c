/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "oauth.h"
#include "library/server/token.h"
#include "library/server/utils.h"

char **users;
int nrUsers;
Permission **permissions;
int nrPermissions;

ResponseAuthToken* request_auth_token_1_svc(char **argp, struct svc_req *rqstp)
{
	static ResponseAuthToken  result;

	char* idClient = argp[0];

	if(isIdAllowed(idClient)){
		result.header = strdup("SUCCESS");
		result.auth_token = generate_access_token(idClient);
	}else{
		result.header = strdup("USER_NOT_FOUND");
	}
	
	return &result;
}

ResponseSignedToken* request_signed_token_1_svc(char **argp, struct svc_req *rqstp)
{
	static ResponseSignedToken  result;
	
	char* auth_token = argp[0];

	Permission *clientPermissions = getNextPossiblePermission(permissions, nrPermissions);

	if(isAcceptedByUsed(clientPermissions)){
		result.header = strdup("SUCCESS");
		char *unsigned_token = appendAuthTokenAndClientPermissions(auth_token, clientPermissions);
		result.signed_token = encrypt(unsigned_token);
	}else{
		result.header = strdup("REQUEST_DENIED");
	}

	return &result;
}

ResponseBearerToken* request_bearer_token_1_svc(char **argp, struct svc_req *rqstp)
{
	static ResponseBearerToken  result;
	result.header = calloc(1, 20);
	result.refresh_token = calloc(1, TOKEN_LEN);
	result.ttl = 5;
	
	char* signed_token = argp[0];
	char* unsigned_token = decrypt(signed_token);

	char *auth_token;
	Permission *clientPermissions;
	int nr = getAuthTokenAndClientPermissions(unsigned_token, &auth_token, &clientPermissions);

	// printf("%d\n", nr);
	// printf("|%s|\n", clientPermissions[0].file);
	// printf("|%s|\n", clientPermissions[0].rights);

	printf("|%s|\n", auth_token);
	result.access_token = generate_access_token(auth_token);
	printf("|%s|\n\n", result.access_token);

	return &result;
}
